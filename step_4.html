<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>RentEasy - Review Your Listing</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3B82F6",
                        "background-light": "#F9FAFB",
                        "background-dark": "#111827",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 20px;
        }
    </style>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script type="module" src="./supabaseClient.js"></script>




</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">

    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <header class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
            <div class="container mx-auto px-6 py-4">
                <nav class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl"><a href="mindex.html"><img src="mlogo.png" width="90vw"></a></span>
                        <h2 class="text-xl font-bold">Your House</h2>
                    </div>
                    <div class="hidden md:flex flex-1 items-center justify-center gap-8">
                        <a href="mindex.html">Home</a>
                        <a href="mabout.html">About us</a>
                        <a href="mcontact.html">Contact</a>
                        <a href="mhelp.html">Help</a>
                    </div>
                </nav>
            </div>
        </header>

        <main class="flex-grow px-4 sm:px-6 lg:px-8 py-8 md:py-12 flex justify-center">
            <div class="w-full max-w-4xl flex flex-col gap-8">

                <!-- Header -->
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex flex-col gap-2">
                        <p class="text-3xl md:text-4xl font-black">Review Your Listing</p>
                        <p class="text-gray-500">Step 4 of 4: Review everything before publishing.</p>
                    </div>

                    <div class="flex gap-2">
                        <button class="h-10 px-4 bg-white border rounded-lg">
                            <a href="step_3.html">Back</a>
                        </button>

                        <button id="saveDraftBtn" class="px-6 py-2 border rounded-lg hover:bg-gray-200">Save as Draft</button>


                    </div>
                </div>

                <!-- Preview -->
                <div class="flex flex-col gap-6">
                    <h2 class="text-[22px] font-bold pt-5">Listing Preview</h2>

                    <div class="flex flex-col xl:flex-row bg-white dark:bg-gray-800 border rounded-lg shadow-md overflow-hidden">

                        <div class="w-full xl:w-2/5 bg-center bg-cover aspect-video xl:aspect-square"
                            id="r_cover"
                            style="background-image:url('https://via.placeholder.com/600x400');">
                        </div>

                        <div class="flex w-full flex-col p-4 xl:p-6">

                            <p class="text-gray-500 text-sm" id="r_type">Apartment</p>

                            <p class="text-xl font-bold" id="r_title">Listing Title</p>

                            <div class="flex items-center gap-2 text-gray-500 mt-1">
                                <span class="material-symbols-outlined !text-base">location_on</span>
                                <p id="r_desc">Address or description</p>
                            </div>

                            <p class="text-gray-500 mt-1" id="r_rooms">Rooms details</p>

                            <div class="flex items-end justify-between mt-4">
                                <p class="text-2xl font-bold">
                                    <span id="r_price">$0</span>
                                    <span class="text-base text-gray-500">/month</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Two Column Sections -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- Property Details -->
                    <div class="p-6 bg-white dark:bg-gray-800 border rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold mb-2">Property Details</h3>
                        <p><strong class="text-[#1F2937] dark:text-gray-300">City:</strong>
                            <span id="show_city">---</span>
                        </p>
                        <p><strong class="text-[#1F2937] dark:text-gray-300">Area:</strong>
                            <span id="show_area">---</span>
                        </p>

                        <p><strong>Type:</strong> <span id="r_type2">N/A</span></p>
                        <p><strong>Square Feet:</strong> <span id="r_area">N/A</span></p>
                    </div>

                    <!-- Amenities -->
                    <div class="p-6 bg-white dark:bg-gray-800 border rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold mb-2">Amenities & Features</h3>
                        <ul id="r_amenities" class="grid grid-cols-2 gap-2 text-gray-600"></ul>
                    </div>

                    <!-- Photos -->
                    <div class="md:col-span-2 p-6 bg-white dark:bg-gray-800 border rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold mb-2">Photos & Media</h3>
                        <div id="r_photos" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Pricing -->
                    <div class="p-6 bg-white dark:bg-gray-800 border rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold mb-2">Pricing & Availability</h3>
                        <p><strong class="text-[#1F2937] dark:text-gray-300">Monthly Rent:</strong>
                            <span id="show_price">$0</span>
                        </p>
                    </div>

                </div>

                <!-- Publish -->
                <div class="flex flex-col gap-4 mt-8 border-t pt-8">
                    <div class="flex items-start">
                        <input class="h-4 w-4 text-primary rounded" id="terms" type="checkbox" />
                        <label class="ms-2 text-sm">
                            I agree to the Terms of Service.
                        </label>
                    </div>

                    <button id="publishBtn" class="w-full md:w-auto h-12 px-8 bg-primary text-white rounded-lg font-semibold">
                        Publish Listing
                    </button>

                </div>

            </div>
        </main>
    </div>
<!-- step_4.html: replace the page scripts with this module -->

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

<!-- FIREBASE AUTH -->
<script>
  const firebaseConfig = {
      apiKey: "AIzaSyCvLYIhxscfR7fyUW0qBGMd2SMfRMBv2j0",
      authDomain: "renteasy-12c60.firebaseapp.com",
      projectId: "renteasy-12c60",
      storageBucket: "renteasy-12c60.firebasestorage.app",
      messagingSenderId: "1061764678588",
      appId: "1:1061764678588:web:ac801c6587c6b5f04321b9"
  };

  firebase.initializeApp(firebaseConfig);

  window.currentUser = null;

  firebase.auth().onAuthStateChanged((user) => {
      window.currentUser = user;
      console.log("Auth ready:", user ? user.email : "Not logged in");
  });
</script>


<!-- MAIN LOGIC -->
<script type="module">
  window.supabase = supabase;

import { supabase } from "./supabaseClient.js";


const SUPABASE_BASE_URL =
  "https://wajkisiwqfqoihleibtl.supabase.co/storage/v1/object/public/listing_images/";
const RENDER_API_URL = "https://democheck-zv5p.onrender.com";

function $(id) {
  return document.getElementById(id);
}
function getDraftId() {
  const p = new URLSearchParams(location.search);
  return p.get("draftId") || localStorage.getItem("draftId") || null;
}

/* =================================================
   LOAD FINAL DATA (DRAFT FIRST ‚Üí BACKEND FALLBACK)
==================================================*/
window.addEventListener("load", async () => {
  const draftId = getDraftId();

  // ================================
  // LOAD DRAFT (CLEAN VERSION)
  // ================================
  if (draftId) {
    const { data, error } = await supabase
      .from("drafts")
      .select("*")
      .eq("id", draftId)
      .single();

    if (!error && data) {

      // REMOVE unwanted fields (VERY IMPORTANT)
      delete data.id;
      delete data.firebase_uid;
      delete data.status;
      delete data.created_at;
      delete data.updated_at;

      // SAVE clean draft
      window.currentDraft = data;

      // Convert cleaned draft to final structure
      window.finalListingData = convertDraftToFinal(data);

      // Fill UI Preview
      fillPreview(window.finalListingData);

      return; // STOP ‚Äî no backend fallback needed
    }
  }

  // ================================
  // BACKEND FALLBACK (IF NO DRAFT)
  // ================================
  const listing_id = localStorage.getItem("listingId");
  if (!listing_id) return;

  try {
    const res = await fetch(`${RENDER_API_URL}/get-listing/${listing_id}`);
    const json = await res.json();

    if (json.status === "success") {
      window.finalListingData = json.data;
      fillPreview(json.data);
    }
  } catch (err) {
    console.error(err);
  }
});

/* =================================================
   CONVERT DRAFT ‚Üí FINAL STRUCTURE
==================================================*/
function convertDraftToFinal(d) {
  
  let photos = {};
  try { 
      photos = JSON.parse(d.photos);   // <-- direct object, no array
  } catch {
      photos = {};
  }

  let amenities = {};
  try { 
      amenities = JSON.parse(d.amenities); // SUPABASE TEXT ‚Üí JSON
  } catch {
      amenities = d.amenities || {};
  }

  return {
    step1: {
      property_title: d.title || "",
      description: d.description || "",
      property_type: d.property_type || "",
      bedrooms: d.bedrooms || 0,
      bathrooms: d.bathrooms || 0,
      total_area: d.area_sqft || 0,
    },

    step2: amenities,

    step3: {
      price: d.rent || 0,
      city: d.city || "",
      area: d.area_name || "",
    },

    media: {
      image1: photos.image1 || null,
      image2: photos.image2 || null,
      image3: photos.image3 || null,
      image4: photos.image4 || null,
    }
  };
}



function fillAmenities(a) {
  const box = $("r_amenities");
  box.innerHTML = "";

  const labels = {
    wifi: "WiFi",
    tv: "TV",
    ac: "Air Conditioning",
    heating: "Heating",
    washer: "Washer",
    dryer: "Dryer",
    refrigerator: "Refrigerator",
    stove: "Stove",
    microwave: "Microwave",
    coffee_maker: "Coffee Maker",
    dishwasher: "Dishwasher",
    smoke_alarm: "Smoke Alarm",
    co_alarm: "CO Alarm",
    first_aid: "First Aid Kit",
    fire_extinguisher: "Fire Extinguisher",
  };
  
  for (const k in a) {
    if (a[k]) {
      const li = document.createElement("li");
      li.textContent = labels[k] || k;
      box.appendChild(li);
    }
  }
}

/* =================================================
   ADD ‚Äî MISSING UI PREVIEW FILL
==================================================*/
function fillPreview(f) {

  $("r_title").textContent  = f.step1.property_title || "---";
  $("r_desc").textContent   = f.step1.description   || "---";
  $("r_type").textContent   = f.step1.property_type || "---";
  $("r_type2").textContent  = f.step1.property_type || "---";

  $("r_rooms").textContent  = `${f.step1.bedrooms} Bedroom ‚Ä¢ ${f.step1.bathrooms} Bath ‚Ä¢ ${f.step1.total_area} sqft`;

  $("show_city").textContent  = f.step3.city  || "---";
  $("show_area").textContent  = f.step3.area  || "---";
  $("show_price").textContent = f.step3.price || 0;
  $("r_price").textContent    = f.step3.price || 0;
  $("r_area").textContent     = f.step1.total_area || 0;

  /* -------- COVER IMAGE FIX -------- */
  if (f.media.image1)
    $("r_cover").style.backgroundImage = `url(${SUPABASE_BASE_URL}${f.media.image1})`;

  /* -------- PHOTOS RENDER -------- */
  const box = $("r_photos");
  box.innerHTML = "";

  ["image1","image2","image3","image4"].forEach(k=>{
    if(f.media[k]){
      let img=document.createElement("img");
      img.src = SUPABASE_BASE_URL + f.media[k];
      img.className = "w-full h-28 object-cover rounded-lg shadow";
      box.appendChild(img);
    }
  });

  fillAmenities(f.step2);
}


/* =================================================
   SAVE DRAFT
==================================================*/
async function saveDraft() {

    const user = firebase.auth().currentUser;
    if (!user) return alert("‚ö† Login required to save draft");
    if (!window.finalListingData) return alert("‚ö† No data to save");

    const f = window.finalListingData;
    const listing_id = localStorage.getItem("listingId");

    const draftPayload = {
        id: getDraftId() || undefined,
        firebase_uid: user.uid,
        listing_id: listing_id,

        // Mapped directly to your Supabase table columns
        title: f.step1.property_title,
        description: f.step1.description,
        property_type: f.step1.property_type,
        bedrooms: f.step1.bedrooms,
        bathrooms: f.step1.bathrooms,
        area_sqft: f.step1.total_area,

        amenities: JSON.stringify(f.step2),  // stored as TEXT
        rent: f.step3.price,
        city: f.step3.city,
        area_name: f.step3.area,

        photos: JSON.stringify(f.media), // table column exists!

        status: "draft"
    };

    const { data, error } = await supabase
        .from("drafts")
        .upsert(draftPayload)
        .select();

    if (error) {
        console.error(error);
        alert("‚ùå Failed to save draft");
    } else {
        alert("‚úî Draft Saved Successfully!");
        localStorage.setItem("draftId", data[0].id);
        window.location.href = "user.html";
    }
}





/* ‚≠ê ADD THIS ‚Äî FIX SAVE DRAFT BUTTON */
document.getElementById("saveDraftBtn").addEventListener("click", saveDraft);


/* =================================================
   FIXED ‚Äî PUBLISH LISTING LOGIC
==================================================*/
$("publishBtn").addEventListener("click", async () => {

    if (!document.getElementById("terms").checked)
        return alert("Accept the Terms first");

    if (!window.finalListingData)
        return alert("No final data found");

    const f = window.finalListingData;

    const newListing = {
        listing_id: localStorage.getItem("listingId") || f.listing_id,
        property_title: f.step1.property_title,
        description: f.step1.description,
        property_type: f.step1.property_type,
        bedrooms: Number(f.step1.bedrooms),
        bathrooms: Number(f.step1.bathrooms),
        total_area: Number(f.step1.total_area),
        amenities: JSON.stringify(f.step2),
        price: Number(f.step3.price),
        city: f.step3.city,
        area: f.step3.area,
        image1: f.media.image1 || null,
        image2: f.media.image2 || null,
        image3: f.media.image3 || null,
        image4: f.media.image4 || null
    };

    // INSERT LISTING ‚úÖ
    const { data, error } = await supabase
        .from("step4")
        .insert([newListing])
        .select();

    if (error) return alert("‚ùå Publish failed ‚Äî check console");

    // AUTO DELETE DRAFT ON PUBLISH üî•
    if (getDraftId()) {
        await supabase.from("drafts").delete().eq("id", getDraftId());
        localStorage.removeItem("draftId");
    }

    alert("üéâ Listing Published Successfully!");
    window.location.href = "main_home.html";
});



</script>

    


</body>


</html>
