<!doctype html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>profile</title>

    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        /* Design tokens */
        :root {
            --primary: #135bec;
            --background-light: #f6f6f8;
            --background-dark: #101622;
            --text: #212529;
            --muted: #6C757D;
            --border: #e9ecef;
            --card-bg: #ffffff;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            font-family: "Spline Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        .dark {
            --card-bg: #0b1220;
            --text: #ffffff;
            --muted: #9aa3b2;
            --border: #2b3440;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-family: 'Material Symbols Outlined';
            vertical-align: middle;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            margin: 0;
            background-color: var(--background-light);
            color: var(--text);
            font-size: 14px;
            line-height: 1.4;
        }

        .layout-root { display: flex; min-height: 100vh; width: 100%; overflow-x: hidden; }

        aside.app-sidebar {
            position: fixed; left: 0; top: 0; height: 100vh; width: 16rem; padding: 1.5rem;
            display: none; flex-direction: column; gap: 1rem; background: var(--card-bg);
            border-right: 1px solid var(--border); color: var(--text);
        }

        @media (min-width: 1024px) {
            aside.app-sidebar { display: flex; }
            main.app-main { margin-left: 16rem; }
        }

        aside .brand { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 2rem; }
        aside .brand h2 { margin: 0; font-size: 1.125rem; font-weight: 700; }
        nav.aside-nav { display: flex; flex-direction: column; gap: 0.5rem; }
        nav.aside-nav a { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none; color: inherit; cursor: pointer; }
        nav.aside-nav a:hover, nav.aside-nav a:focus { background: #f3f4f6; outline: none; }
        .active-link { background: #f3f4f6; color: var(--primary); font-weight: 700; }

        button.new-post {
            width: 100%; margin-top: 1.5rem; height: 3rem; border-radius: 0.5rem;
            background: var(--primary); color: white; border: none; font-weight: 700; cursor: pointer;
        }
        button.new-post:active { transform: translateY(1px); }

        .sidebar-profile { display: flex; gap: 0.75rem; align-items: center; margin-top: 1rem; }
        .avatar { width: 2.5rem; height: 2.5rem; border-radius: 9999px; background-size: cover; background-position: center; }
        .sidebar-profile p { margin: 0; }
        .sidebar-profile .name { font-weight: 700; font-size: 0.875rem; }
        .sidebar-profile .handle { color: var(--muted); font-size: 0.875rem; }

        main.app-main { flex: 1; display: flex; flex-direction: column; }
        .container { max-width: 90rem; margin: 0 auto; padding: 2rem 1rem; width: 100%; }

        .cover {
            width: 100%; min-height: 280px; border-radius: 0.75rem;
            background-position: center; background-size: cover; display: flex; align-items: flex-end; overflow: hidden;
        }

        .profile-header { display: flex; flex-direction: column; gap: 0.75rem; margin-top: -4rem; z-index: 10; }
        @media (min-width:768px) { .profile-header { flex-direction: row; align-items: flex-end; margin-top: -5rem; } }

        .profile-avatar { width: 8rem; height: 8rem; border-radius: 9999px; border: 4px solid white; background-size: cover; background-position: center; }
        .profile-info { display: flex; flex-direction: column; justify-content: center; }
        .profile-info .name { font-size: 1.5rem; font-weight: 800; margin: 0; }
        .profile-info .handle { color: var(--muted); margin: 0; }
        .profile-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; }
        .btn.secondary { background: #e9ecef; color: var(--text); }
        .btn.secondary:hover { transform: translateY(-2px); }
        .icon-btn { width: 2.5rem; height: 2.5rem; display: inline-flex; align-items: center; justify-content: center; border-radius: 0.5rem; background: #e9ecef; cursor: pointer; }

        .profile-grid { margin-top: 2rem; display: grid; gap: 2rem; grid-template-columns: 1fr; }
        @media (min-width:1024px) { .profile-grid { grid-template-columns: 320px 1fr; } }

        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 1.25rem; border-radius: 0.75rem; }
        .card h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }
        .muted { color: var(--muted); font-size: 0.875rem; }
        .info-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem; }

        .stats { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; }
        .stat { flex: 1 1 auto; min-width: 111px; background: var(--card-bg); border: 1px solid var(--border); padding: 1rem; border-radius: 0.75rem; }
        .stat .value { font-size: 1.5rem; font-weight: 800; margin: 0; }
        .stat .label { color: var(--muted); font-size: 0.875rem; }

        .tabs { background: var(--card-bg); border: 1px solid var(--border); border-radius: 0.75rem; overflow: hidden; }
        .tabs .tab-bar { display: flex; gap: 1rem; align-items: center; padding: 0 1rem; border-bottom: 1px solid var(--border); }
        .tab-bar button { background: transparent; border: none; padding: 1rem 0.5rem; font-weight: 700; cursor: pointer; color: var(--muted); }
        .tab-bar button.active { color: var(--primary); border-bottom: 4px solid var(--primary); padding-bottom: 0.25rem; }

        .search { margin-left: auto; display: flex; align-items: center; position: relative; }
        .search input { padding: 0.5rem 0.75rem 0.5rem 2.25rem; border-radius: 0.5rem; border: none; background: #f3f4f6; color: var(--text); }
        .search .icon { position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%); }

        .media-grid { padding: 1rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (min-width:640px) { .media-grid { grid-template-columns: repeat(3, 1fr); } }
        .media-item { aspect-ratio: 1 / 1; background-size: cover; background-position: center; border-radius: 0.5rem; }

        .clickable { cursor: pointer; }

        /* Modal styles */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { width: 100%; max-width: 640px; background: var(--card-bg); border-radius: 12px; padding: 1.25rem; box-shadow: 0 8px 30px rgba(2, 6, 23, 0.35); }
        .modal-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .modal-title { font-weight: 800; font-size: 1.125rem; margin: 0; }
        .modal-body { margin-top: 1rem; display: flex; gap: 1rem; flex-direction: column; }
        .form-row { display: flex; gap: 0.75rem; }
        .form-field { flex: 1; display: flex; flex-direction: column; gap: 0.25rem; }
        .form-field label { font-size: 0.75rem; color: var(--muted); }
        .form-field input[type='text'], .form-field textarea { padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border); background: #fff; }
        .form-field textarea { min-height: 80px; resize: vertical; }
        .avatar-preview { width: 96px; height: 96px; border-radius: 9999px; background-size: cover; background-position: center; border: 1px solid var(--border); }
        .modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
        .btn.primary { background: var(--primary); color: white; }
        .btn.ghost { background: transparent; border: 1px solid var(--border); }

        /* Custom Draft List Styles to match your UI */
        #draftsContainer { padding: 1rem; }
        .draft-card { display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; }
        .draft-btn { background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; text-decoration: none; font-weight: 500; font-size: 0.875rem; }
    </style>
</head>

<body>
    <div class="layout-root">

        <aside class="app-sidebar" aria-label="Sidebar">
<div class="brand flex items-center gap-3">
    <span class="text-2xl"><a href="mindex.html"><img src="mlogo.png" width="90vw"></a></span>
    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Your House</h2>
</div>



            <nav class="aside-nav" aria-label="Main navigation" id="sidebarNav">
                <a href="mindex.html"><span class="material-symbols-outlined">home</span><span>Home</span></a>
                <a href="user.html" class="active-link"><span class="material-symbols-outlined">person</span><span>Profile</span></a>
                <a href="notifications.html"><span class="material-symbols-outlined">notifications</span><span>Notifications</span></a>
            </nav>

            <a href="upload_photos.html"><button class="new-post" id="newPostBtn">New Post</button></a>

            <div style="margin-top:auto; display:flex; flex-direction:column; gap:1rem;">
                <div class="sidebar-profile">
                    <div class="avatar" id="sidebarAvatar" style="background-image:url('/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png');"></div>
                    <div>
                        <p class="name" id="sidebarName">Alex Doe</p>
                        <p class="handle" id="sidebarHandle">@alex_doe</p>
                    </div>
                    <button id="moreBtn" style="margin-left:auto; background:none; border:none; color:var(--muted); cursor:pointer;"><span class="material-symbols-outlined">more_horiz</span></button>
                </div>
            </div>
        </aside>

        <main class="app-main">
            <div class="container">
                <div class="cover" id="coverImage" style="background-image:url('/mnt/data/2ce828db-3918-4fc9-b880-928190de46dd.png');"></div>

                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar" style="background-image:url('/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png');"></div>

                    <div style="flex:1; display:flex; flex-direction:row; justify-content:space-between; align-items:flex-end;">
                        <div class="profile-info">
                            <p class="name" id="displayName">Alex Doe</p>
                            <p class="handle muted" id="displayHandle">@alex_doe</p>
                        </div>

                        <div class="profile-actions">
                            <button class="btn secondary" id="editProfileBtn">Edit Profile</button>
                            <button class="icon-btn" id="sendBtn"><span class="material-symbols-outlined">send</span></button>
                            <button class="icon-btn" id="settingsBtn"><span class="material-symbols-outlined">settings</span></button>
                        </div>
                    </div>
                </div>

                <div class="profile-grid">
                    <div>
                        <div class="card">
                            <h3>About</h3>
                            <p class="muted" id="displayAbout" style="margin-top:0.5rem;">Product Designer at Innovate Inc. | Capturing moments and creating beautiful, user-centric digital experiences. Coffee enthusiast &amp; travel lover.</p>
                            <div style="margin-top:1rem; display:flex; flex-direction:column; gap:0.5rem;">
                                <div class="info-row muted"><span class="material-symbols-outlined">location_on</span><span id="displayLocation">San Francisco, CA</span></div>
                                <div class="info-row muted"><span class="material-symbols-outlined">link</span><a href="#" id="profileLink" style="color:var(--primary); text-decoration:none;">alexdoe.design</a></div>
                            </div>
                        </div>

                        <div class="stats">
                            <div class="stat clickable" data-action="posts">
                                <p class="value">1,204</p><p class="label">Posts</p>
                            </div>
                            <div class="stat clickable" data-action="followers">
                                <p class="value">15.8K</p><p class="label">Followers</p>
                            </div>
                            <div class="stat clickable" data-action="following">
                                <p class="value">832</p><p class="label">Following</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="tabs">
                            <div class="tab-bar" role="tablist" aria-label="Profile tabs">
                                <button class="active" data-tab="posts">Posts</button>
                                <button data-tab="media">Media</button>
                                <button data-tab="likes">Likes</button>
                                <button data-tab="all">All</button>
                                
                                <div style="flex:1"></div>
                                <div class="search">
                                    <span class="icon material-symbols-outlined">search</span>
                                    <input placeholder="Search" type="text" id="searchInput" aria-label="Search posts" />
                                </div>
                            </div>

                            <div id="postsContainer">
                                <div class="media-grid" id="mediaGrid">
                                    <div class="media-item" style="background-image:url('/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png');"></div>
                                    <div class="media-item" style="background-image:url('/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png');"></div>
                                    <div class="media-item" style="background-image:url('/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png');"></div>
                                </div>
                            </div>

                            <div id="draftsContainer" style="display: none;">
                                <div id="draftList"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div class="modal-backdrop" id="editModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" role="document" aria-labelledby="editModalTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="editModalTitle">Edit Profile</h3>
                <button id="closeModalBtn" class="icon-btn" aria-label="Close modal"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:1rem; align-items:center;">
                    <div class="avatar-preview" id="avatarPreview" style="background-image:url('/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png');"></div>
                    <div style="display:flex; flex-direction:column; gap:0.5rem;">
                        <label for="avatarInput" style="font-size:0.875rem; color:var(--muted);">Change avatar</label>
                        <input type="file" id="avatarInput" accept="image/*" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field"><label for="inputName">Display name</label><input id="inputName" type="text" /></div>
                    <div class="form-field"><label for="inputHandle">Handle</label><input id="inputHandle" type="text" /></div>
                </div>
                <div class="form-field"><label for="inputAbout">About</label><textarea id="inputAbout"></textarea></div>
                <div class="form-row">
                    <div class="form-field"><label for="inputLocation">Location</label><input id="inputLocation" type="text" /></div>
                    <div class="form-field"><label for="inputWebsite">Website</label><input id="inputWebsite" type="text" /></div>
                </div>
                <div class="modal-actions">
                    <button class="btn ghost" id="cancelEditBtn">Cancel</button>
                    <button class="btn primary" id="saveEditBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ---------- CONFIGURATION ----------
const firebaseConfig = {
    apiKey: "AIzaSyCvLYIhxscfR7fyUW0qBGMd2SMfRMBv2j0",
    authDomain: "renteasy-12c60.firebaseapp.com",
    projectId: "renteasy-12c60",
    storageBucket: "renteasy-12c60.firebasestorage.app",
    messagingSenderId: "1061764678588",
    appId: "1:1061764678588:web:ac801c6587c6b5f04321b9"
};

const SUPABASE_URL = "https://wajkisiwqfqoihleibtl.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhamtpc2l3cWZxb2lobGVpYnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDQxMzksImV4cCI6MjA3OTQ4MDEzOX0.i-kXWQt_-6cYZXvTwMFZ2WQo4wmg2nRE7inLPXk8Y9s";
const SUPABASE_BUCKET = "avatars";


// Initialize Services
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ---------- DOM ELEMENTS ----------
        const displayNameEl = document.getElementById('displayName');
        const displayHandleEl = document.getElementById('displayHandle');
        const sidebarNameEl = document.getElementById('sidebarName');
        const sidebarHandleEl = document.getElementById('sidebarHandle');
        const profileAvatarEl = document.getElementById('profileAvatar');
        const sidebarAvatarEl = document.getElementById('sidebarAvatar');
        const avatarPreviewEl = document.getElementById('avatarPreview');
        
        // Form inputs
        const inputName = document.getElementById('inputName');
        const inputHandle = document.getElementById('inputHandle');
        const inputAbout = document.getElementById('inputAbout');
        const inputLocation = document.getElementById('inputLocation');
        const inputWebsite = document.getElementById('inputWebsite');
        const avatarInput = document.getElementById('avatarInput');

        // Containers
        const draftsContainer = document.getElementById('draftsContainer');
        const draftListEl = document.getElementById('draftList');

        // ---------- HELPER UTILITIES ----------
        function safeHandleFromEmail(email) {
            if (!email) return 'user';
            const namePart = email.split('@')[0] || 'user';
            return namePart.replace(/[.\s]/g, '_').toLowerCase();
        }

        function capitalizeWords(str) {
            return str.replace(/\b\w/g, ch => ch.toUpperCase());
        }

        function initialsAvatarDataURL(nameOrEmail, size = 256, bg = '#e2e8f0', fg = '#1f2937') {
            const text = (nameOrEmail || 'U').split(/\s|\.|@/).filter(Boolean).slice(0, 2).map(s => s[0].toUpperCase()).join('');
            const fontSize = Math.round(size / 3);
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><rect width='100%' height='100%' rx='50%' fill='${bg}'/><text x='50%' y='50%' dy='.1em' text-anchor='middle' font-family='Arial, sans-serif' font-size='${fontSize}' fill='${fg}' font-weight='700'>${text}</text></svg>`;
            return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
        }

        function redirectToLogin() {
            window.location.href = 'login_signup.html';
        }

        // ---------- FIRESTORE PROFILE LOGIC ----------
        async function saveProfileToFirestore(uid, data) {
            const docRef = db.collection('users').doc(uid);
            data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            await docRef.set(data, { merge: true });
        }

        async function loadProfileFromFirestore(uid) {
            const doc = await db.collection('users').doc(uid).get();
            if (!doc.exists) return null;
            return doc.data();
        }

        async function uploadAvatarFile(uid, file) {
            if (!file) return null;
            const ext = file.name.split('.').pop().toLowerCase();
            const filename = `avatar_${Date.now()}.${ext}`;
            const filePath = `${uid}/${filename}`;
            const { data: uploadData, error: uploadError } = await supabase.storage.from(SUPABASE_BUCKET).upload(filePath, file, { cacheControl: "3600", upsert: true });
            if (uploadError) { throw uploadError; }
            const { data } = supabase.storage.from(SUPABASE_BUCKET).getPublicUrl(filePath);
            return data.publicUrl;
        }

        function applyProfileToUI(profile, user) {
            if (!profile && !user) return;
            const email = (user && user.email) || (profile && profile.email) || '';
            const name = (profile && profile.displayName) || (user && user.displayName) || (email.split('@')[0] ? capitalizeWords(email.split('@')[0].replace(/[._]/g, ' ')) : 'User');
            const handle = (profile && profile.handle) || '@' + safeHandleFromEmail(email || (profile && profile.email) || name.toLowerCase());
            const about = (profile && profile.about) || 'Product Designer at Innovate Inc.';
            const location = (profile && profile.location) || 'San Francisco, CA';
            const website = (profile && profile.website) || 'alexdoe.design';
            const avatarUrl = (profile && profile.avatarUrl) || (user && user.photoURL) || initialsAvatarDataURL(user && user.displayName ? user.displayName : email);

            displayNameEl.textContent = name;
            displayHandleEl.textContent = handle;
            sidebarNameEl.textContent = name;
            sidebarHandleEl.textContent = handle;
            profileAvatarEl.style.backgroundImage = `url('${avatarUrl}')`;
            sidebarAvatarEl.style.backgroundImage = `url('${avatarUrl}')`;
            avatarPreviewEl.style.backgroundImage = `url('${avatarUrl}')`;

            inputName.value = name;
            inputHandle.value = handle.replace('@', '');
            inputAbout.value = about;
            inputLocation.value = location;
            inputWebsite.value = website;

            document.getElementById('displayAbout').textContent = about;
            document.getElementById('displayLocation').textContent = location;
            document.getElementById('profileLink').textContent = website;
        }

        // ---------- SUPABASE DRAFT FETCH LOGIC ----------
async function fetchDrafts(uid) {
    console.log("Fetching drafts for UID:", uid);
    
    const { data, error } = await supabase
        .from("drafts")
        .select("*")
        .eq("firebase_uid", uid)
        .eq("status", "draft")   // â¬… SHOW ONLY DRAFTS
        .order("updated_at", { ascending: false });

    if (error) {
        console.error("Draft fetch error:", error);
        draftListEl.innerHTML = `<p style="color:red; text-align:center;">Error: ${error.message}. Check Supabase Policies.</p>`;
        return;
    }
    
    console.log("Filtered Drafts:", data);
    renderDrafts(data);
}

        function renderDrafts(drafts) {
            draftListEl.innerHTML = "";

            if (!drafts || drafts.length === 0) {
                draftListEl.innerHTML = `<p style="color:var(--muted); text-align:center; padding: 2rem;">No saved drafts found.</p>`;
                return;
            }

            drafts.forEach(d => {
                const div = document.createElement("div");
                div.className = "draft-card";
                div.innerHTML = `
                    <div>
                        <h3 style="margin:0; font-size:1rem; font-weight:700;">${d.title || "Untitled Draft"}</h3>
                        <p style="margin:0.25rem 0 0; color:var(--muted); font-size:0.875rem;">${d.city || "Unknown City"}</p>
                        <p style="margin:0; color:#aaa; font-size:0.75rem;">Updated: ${new Date(d.updated_at).toLocaleDateString()}</p>
                    </div>
                    <a href="step_4.html?draftId=${d.id}" class="draft-btn">Continue</a>
                `;
                draftListEl.appendChild(div);
            });
            
        }
        

        // ---------- MAIN AUTH LISTENER ----------
        auth.onAuthStateChanged(async (user) => {
            if (!user) return redirectToLogin();
            
            // 1. Load Profile
            try {
                const profile = await loadProfileFromFirestore(user.uid);
                applyProfileToUI(profile, user);
            } catch (err) {
                console.error('Failed to load profile:', err);
                applyProfileToUI(null, user);
            }

            // 2. Fetch Drafts from Supabase
            fetchDrafts(user.uid);
        });

        // ---------- UI INTERACTIVITY ----------
        (function () {
            // Sidebar
            const sidebarNav = document.getElementById('sidebarNav');
            sidebarNav.addEventListener('click', (e) => {
                const anchor = e.target.closest('a[data-key]');
                if (!anchor) return;
                [...sidebarNav.querySelectorAll('a')].forEach(a => a.classList.remove('active-link'));
                anchor.classList.add('active-link');
            });

            // Tab Switching Logic
            const tabButtons = document.querySelectorAll('.tab-bar button[data-tab]');
            const mediaGrid = document.getElementById('mediaGrid');
            const postsContainer = document.getElementById('postsContainer');
            
            function setActiveTab(tab) {
                tabButtons.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));

                if (tab === 'all') {
                    // Hide Posts, Show Drafts
                    if(postsContainer) postsContainer.style.display = 'none';
                    if(draftsContainer) draftsContainer.style.display = 'block';
                } else {
                    // Show Posts, Hide Drafts
                    if(postsContainer) postsContainer.style.display = 'block';
                    if(draftsContainer) draftsContainer.style.display = 'none';

                    // Switch mock content for Posts/Media/Likes
                    if(mediaGrid) {
                        if (tab === 'media') {
                            mediaGrid.innerHTML = '<div class="media-item" style="background-image:url(\'/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png\');"></div><div class="media-item" style="background-image:url(\'/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png\');"></div>';
                        } else if (tab === 'posts') {
                            mediaGrid.innerHTML = '<div class="media-item" style="background-image:url(\'/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png\');"></div><div class="media-item" style="background-image:url(\'/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png\');"></div><div class="media-item" style="background-image:url(\'/mnt/data/39673b57-8b74-43df-95f3-3e832101f53a.png\');"></div>';
                        } else if (tab === 'likes') {
                            mediaGrid.innerHTML = '<div style="padding:1rem; color:var(--muted);">No liked items yet.</div>';
                        }
                    }
                }
            }
            tabButtons.forEach(b => b.addEventListener('click', () => setActiveTab(b.dataset.tab)));

            // Modal Logic
            const editBtn = document.getElementById('editProfileBtn');
            const editModal = document.getElementById('editModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const saveEditBtn = document.getElementById('saveEditBtn');

            function openEditModal() {
                editModal.style.display = 'flex';
                editModal.setAttribute('aria-hidden', 'false');
                inputName.focus();
            }
            function closeEditModal() {
                editModal.style.display = 'none';
                editModal.setAttribute('aria-hidden', 'true');
            }

            editBtn.addEventListener('click', openEditModal);
            closeModalBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);

            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (ev) {
                    avatarPreviewEl.style.backgroundImage = `url('${ev.target.result}')`;
                };
                reader.readAsDataURL(file);
            });

            saveEditBtn.addEventListener('click', async () => {
                saveEditBtn.disabled = true;
                const oldLabel = saveEditBtn.textContent;
                saveEditBtn.textContent = 'Saving...';
                try {
                    const user = auth.currentUser;
                    if (!user) return redirectToLogin();
                    
                    const nameVal = inputName.value.trim() || 'Alex Doe';
                    const handleVal = inputHandle.value.trim() ? '@' + inputHandle.value.trim().replace('@','') : '@' + safeHandleFromEmail(user.email || nameVal);
                    
                    const profileData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: nameVal,
                        handle: handleVal,
                        about: inputAbout.value.trim(),
                        location: inputLocation.value.trim(),
                        website: inputWebsite.value.trim()
                    };

                    const file = avatarInput.files && avatarInput.files[0];
                    if (file) {
                        const avatarUrl = await uploadAvatarFile(user.uid, file);
                        if (avatarUrl) profileData.avatarUrl = avatarUrl;
                    }

                    await saveProfileToFirestore(user.uid, profileData);
                    await user.updateProfile({ displayName: profileData.displayName, photoURL: profileData.avatarUrl });
                    applyProfileToUI(profileData, user);

                    saveEditBtn.textContent = 'Saved';
                    setTimeout(() => saveEditBtn.textContent = oldLabel, 1200);
                    closeEditModal();
                } catch (err) {
                    alert('Save failed: ' + err.message);
                    saveEditBtn.textContent = oldLabel;
                } finally {
                    saveEditBtn.disabled = false;
                }
            });

            window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && editModal.style.display === 'flex') closeEditModal(); });
        })();
    </script>
</body>
</html>